<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>前端监控测试</title>
  </head>
  <body>
    <div id="uuy">1</div>
    <div class="xyz">2</div>
    <div class="name">3</div>
    <button>点我！</button>
    <script>
      function getSelectors(path) {
        // 反转 + 过滤 + 映射 + 拼接
        return path
          .reverse()
          .filter((element) => {
            return element !== document && element !== window;
          })
          .map((element) => {
            console.log('element', element);
            console.log('element', element.nodeName);
            let selector = '';
            if (element.id) {
              return `${element.nodeName.toLowerCase()}#${element.id}`;
            } else if (
              element.className &&
              typeof element.className === 'string'
            ) {
              return `${element.nodeName.toLowerCase()}.${element.className}`;
            } else {
              selector = element.nodeName.toLowerCase();
            }
            return selector;
          })
          .join(' ');
      }

      function getSelectorsFromPathsOrTarget(pathsOrTarget) {
        if (Array.isArray(pathsOrTarget)) {
          return getSelectors(pathsOrTarget);
        } else {
          let path = [];
          while (pathsOrTarget) {
            path.push(pathsOrTarget);
            pathsOrTarget = pathsOrTarget.parentNode;
          }
          console.log(path);
          return getSelectors(path);
        }
      }

      const target = document.querySelectorAll('div')[0];
    </script>
    <script>
      // 全局监听未捕获的 Promise 错误
      window.addEventListener('unhandledrejection', (event) => {
        console.log('Unhandled Promise Rejection:', event);
      });

      new Promise(function () {
        throw new Error('Whoops!');
      }); // no catch to handle the error
    </script>
    <script>
      function injectXHR() {
        let XMLHttpRequest = window.XMLHttpRequest;
        let oldOpen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function (method, url, async) {
          // 把上报接口过滤掉
          if (!url.match(/logstores/) && !url.match(/sockjs/)) {
            this.logData = { method, url, async };
          }
          return oldOpen.apply(this, arguments);
        };
        let oldSend = XMLHttpRequest.prototype.send;
        XMLHttpRequest.prototype.send = function (body) {
          if (this.logData) {
            let startTime = Date.now();
            let handler = (type) => (event) => {
              // 持续时间
              let duration = Date.now() - startTime;
              let status = this.status;
              let statusText = this.statusText;
              const sendData = {
                kind: 'stability',
                type: 'xhr',
                eventType: type,
                pathname: this.logData.url,
                status: status + '-' + statusText, // 状态码
                duration,
                response: this.response ? JSON.parse(this.response) : '', // 响应体
                params: body || '', // 入参
              };
              console.log(sendData);
            };
            this.addEventListener('load', handler('load'), false);
            this.addEventListener('error', handler, false);
            this.addEventListener('abort', handler, false);
          }
          return oldSend.apply(this, arguments);
        };
      }

      injectXHR();
    </script>
    <script>
      const btn = document.querySelector('button');
      function sendData(data) {
        const XHR = new XMLHttpRequest();
        const FD = {
          name: 'zs',
          age: 10,
        };

        // 设置请求地址和方法
        XHR.open('GET', 'http://localhost:3000/api/data');

        // 发送这个 formData 对象，HTTP 请求头会自动设置
        XHR.send(FD);
      }

      btn.addEventListener('click', () => {
        sendData({ test: 'ok' });
      });
    </script>
    <script>
      function onload(callback) {
        if (document.readyState === 'complete') {
          callback();
        } else {
          window.addEventListener('load', callback);
        }
      }
      function blankScreen() {
        let wrapperElements = ['html', 'body', '#container', '.content'];
        let emptyPoints = 0;
        function getSelector(element) {
          const { id, className, nodeName } = element;
          if (id) {
            return '#' + id;
          } else if (className) {
            // 过滤空白符 + 拼接
            return (
              '.' +
              className
                .split(' ')
                .filter((item) => !!item)
                .join('.')
            );
          } else {
            return nodeName.toLowerCase();
          }
        }
        function isWrapper(element) {
          let selector = getSelector(element);
          if (wrapperElements.indexOf(selector) !== -1) {
            emptyPoints++;
          }
        }
        // 刚开始页面内容为空，等页面渲染完成，再去做判断
        onload(function () {
          let xElements, yElements;
          for (let i = 0; i < 9; i++) {
            xElements = document.elementsFromPoint(
              (window.innerWidth * i) / 10,
              window.innerHeight / 2
            );
            yElements = document.elementsFromPoint(
              window.innerWidth / 2,
              (window.innerHeight * i) / 10
            );
            isWrapper(xElements[0]);
            isWrapper(yElements[0]);
          }
          // 白屏
          if (emptyPoints > 0) {
            const centerElements = document.elementsFromPoint(
              window.innerWidth / 2,
              window.innerHeight / 2
            );
            console.log(
              'emptyPoints++++++++++++++',
              getSelector(centerElements[0])
            );
            const data = {
              kind: 'stability',
              type: 'blank',
              emptyPoints: emptyPoints + '',
              screen: window.screen.width + 'X' + window.screen.height,
              viewPoint: window.innerWidth + 'X' + window.innerHeight,
              selector: getSelector(centerElements[0]),
            };
            console.log(data);
          }
        });
      }

      blankScreen();
    </script>
    <script></script>
  </body>
</html>
